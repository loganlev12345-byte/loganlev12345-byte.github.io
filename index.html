<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalshi Weather Watchlist</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --muted:#cbd5e1; --muted2:#94a3b8;
      --accent:#2563eb;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
    .wrap{max-width:1200px;margin:0 auto;padding:26px 14px 70px}
    h1{margin:0 0 6px;font-size:32px}
    .sub{color:var(--muted2);margin:0 0 14px;line-height:1.5}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,button,textarea{font:inherit}
    input,textarea{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:#fff;outline:none
    }
    textarea{width:100%;min-height:170px;resize:vertical}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.12);color:#fff;cursor:pointer;font-weight:700
    }
    button.primary{background:var(--accent);border-color:rgba(255,255,255,.18)}
    button:hover{opacity:.92}
    .pill{font-size:12px;color:var(--muted2);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .tiny{font-size:12px;color:var(--muted2)}
    .divider{height:1px;background:var(--border);margin:12px 0}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted2);font-weight:800}
    td{font-size:14px}
    a{color:#c7d2fe}
    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Kalshi × Weather Watchlist</h1>
  <p class="sub">
    Add the markets you’re watching + the exact station Kalshi uses (ex: CLIMDW → <code>KMDW</code>).
    This shows market prices + station obs + station forecast in one place.
  </p>

  <div class="card">
    <div class="row">
      <div class="pill">Proxy (Cloudflare Worker URL):</div>
      <input id="proxy" placeholder="https://your-worker.workers.dev" style="min-width:360px;flex:1">
      <button id="save" class="primary">Save</button>
      <button id="refresh">Refresh</button>
      <span id="status" class="tiny"></span>
    </div>
    <div class="tiny" style="margin-top:8px">
      Proxy is required for Kalshi API calls. Weather uses NWS station endpoints.
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <strong>Watchlist (easy to edit)</strong>
    <div class="tiny muted2" style="margin-top:6px">
      Each item: <code>ticker</code>, <code>kalshiUrl</code>, <code>stationId</code>, optional <code>label</code>.
      Example station: Midway = <code>KMDW</code>, O’Hare = <code>KORD</code>.
    </div>
    <div class="divider"></div>
    <textarea id="watchJson"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="saveWatch" class="primary">Save watchlist</button>
      <button id="loadSample">Load sample</button>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between">
      <strong>Live View</strong>
      <span id="counts" class="tiny"></span>
    </div>
    <div class="divider"></div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Market</th>
            <th>YES Bid</th>
            <th>YES Ask</th>
            <th>Implied P</th>
            <th>Station</th>
            <th>Obs Now</th>
            <th>Forecast High</th>
            <th>Forecast Low</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ------------ Storage ------------ */
const KEY = {
  proxy: "wl_proxy_v1",
  watch: "wl_watch_v1",
};

const SAMPLE_WATCH = [
  {
    "label": "Chicago Low Temp (CLIMDW)",
    "ticker": "KXLOWTCHI-26FEB18",
    "kalshiUrl": "https://kalshi.com/markets/kxlowtchi/lowest-temperature-chicago/kxlowtchi-26feb18",
    "stationId": "KMDW"
  }
];

const $ = (id) => document.getElementById(id);

function load(key, fallback){
  try{ const v = localStorage.getItem(key); return v == null ? fallback : v; }catch{ return fallback; }
}
function save(key, value){ localStorage.setItem(key, value); }
function loadJSON(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch{ return fallback; }
}
function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value, null, 2)); }

function proxyWrap(url){
  const p = $("proxy").value.trim();
  if (!p) return url;
  const u = new URL(p);
  u.searchParams.set("url", url);
  return u.toString();
}

async function fetchJSON(url){
  const res = await fetch(url, { headers: { "Accept": "application/json" }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function pct(x){
  if(x == null || Number.isNaN(x)) return "—";
  return (x*100).toFixed(1) + "%";
}

function extractTopOfBook(orderbookJson){
  const ob = orderbookJson?.orderbook || orderbookJson;
  let yesBids = ob?.yes?.bids || ob?.yes_bids || ob?.yesBids || [];
  let yesAsks = ob?.yes?.asks || ob?.yes_asks || ob?.yesAsks || [];
  const bestBid = yesBids?.[0];
  const bestAsk = yesAsks?.[0];
  const bid = Array.isArray(bestBid) ? bestBid[0] : bestBid?.price;
  const ask = Array.isArray(bestAsk) ? bestAsk[0] : bestAsk?.price;
  const bidNum = (bid == null ? null : Number(bid));
  const askNum = (ask == null ? null : Number(ask));
  const normalize = (x) => (x > 1 ? x/100 : x);
  return { yesBid: bidNum == null ? null : normalize(bidNum), yesAsk: askNum == null ? null : normalize(askNum) };
}

function impliedProb(yesBid, yesAsk){
  if(yesBid == null && yesAsk == null) return null;
  if(yesBid != null && yesAsk != null) return (yesBid + yesAsk) / 2;
  return (yesBid != null ? yesBid : yesAsk);
}

function pickHighLow(periods){
  let high=null, low=null;
  for(const p of periods){
    const name = (p.name||"").toLowerCase();
    if(!high && p.isDaytime === true && !name.includes("night")) high = p;
    if(!low && (p.isDaytime === false || name.includes("night"))) low = p;
    if(high && low) break;
  }
  return { high, low };
}

function fmtForecastTemp(p){
  if(!p || p.temperature == null) return "—";
  if((p.temperatureUnit||"").toUpperCase() === "F") return Math.round(Number(p.temperature)) + "°F";
  return "—";
}

function fmtTempF(tempC){
  if(tempC == null) return "—";
  const f = (tempC * 9/5) + 32;
  return Math.round(f) + "°F";
}

async function fetchStationWeather(stationId){
  // station metadata -> coords
  const st = await fetchJSON(proxyWrap(`https://api.weather.gov/stations/${stationId}`));
  const coords = st?.geometry?.coordinates;
  if(!coords || coords.length < 2) throw new Error("Station geometry missing");
  const lon = coords[0], lat = coords[1];

  // forecast via points
  const points = await fetchJSON(proxyWrap(`https://api.weather.gov/points/${lat},${lon}`));
  const forecastUrl = points?.properties?.forecast;
  if(!forecastUrl) throw new Error("Missing forecast url");
  const forecast = await fetchJSON(proxyWrap(forecastUrl));
  const periods = forecast?.properties?.periods;
  if(!Array.isArray(periods) || !periods.length) throw new Error("No forecast periods");
  const hl = pickHighLow(periods);

  // latest obs
  let obsNowF = "—";
  try{
    const obs = await fetchJSON(proxyWrap(`https://api.weather.gov/stations/${stationId}/observations/latest`));
    const c = obs?.properties?.temperature?.value; // Celsius
    obsNowF = fmtTempF(c);
  }catch{}

  return {
    stationName: st?.properties?.name || stationId,
    obsNowF,
    fcHigh: fmtForecastTemp(hl.high),
    fcLow: fmtForecastTemp(hl.low),
  };
}

function setStatus(msg){ $("status").textContent = msg; }

async function refreshAll(){
  setStatus("Refreshing…");
  const rowsEl = $("rows");
  rowsEl.innerHTML = "";

  const watch = loadJSON(KEY.watch, SAMPLE_WATCH);
  let okPrices = 0, okWx = 0;

  for(const item of watch){
    const label = item.label || item.ticker || "Market";
    const ticker = String(item.ticker || "").toUpperCase();
    const kalshiUrl = item.kalshiUrl || "https://kalshi.com/";
    const stationId = String(item.stationId || "").toUpperCase();

    // Kalshi orderbook
    let yesBid=null, yesAsk=null, imp=null;
    try{
      if(ticker){
        const obUrl = `https://api.elections.kalshi.com/trade-api/v2/markets/${ticker}/orderbook`;
        const ob = await fetchJSON(proxyWrap(obUrl));
        const tob = extractTopOfBook(ob);
        yesBid = tob.yesBid; yesAsk = tob.yesAsk;
        imp = impliedProb(yesBid, yesAsk);
        okPrices++;
      }
    }catch{}

    // Station weather
    let stName="—", obsNowF="—", fcHigh="—", fcLow="—";
    try{
      if(stationId){
        const w = await fetchStationWeather(stationId);
        stName = w.stationName;
        obsNowF = w.obsNowF;
        fcHigh = w.fcHigh;
        fcLow = w.fcLow;
        okWx++;
      }
    }catch{}

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div><strong>${label}</strong></div>
        <div class="tiny">
          <a href="${kalshiUrl}" target="_blank" rel="noreferrer">Open market</a>
          ${ticker ? ` • <span class="tiny muted2">${ticker}</span>` : ""}
        </div>
      </td>
      <td>${yesBid==null?"—":pct(yesBid)}</td>
      <td>${yesAsk==null?"—":pct(yesAsk)}</td>
      <td>${imp==null?"—":pct(imp)}</td>
      <td>
        <div><strong>${stationId || "—"}</strong></div>
        <div class="tiny muted2">${stName}</div>
      </td>
      <td>${obsNowF}</td>
      <td>${fcHigh}</td>
      <td>${fcLow}</td>
    `;
    rowsEl.appendChild(tr);
  }

  $("counts").textContent = `Watching: ${watch.length} • Prices ok: ${okPrices}/${watch.length} • Weather ok: ${okWx}/${watch.length}`;
  setStatus("Done.");
}

/* ------------ UI wiring ------------ */
$("save").onclick = () => {
  save(KEY.proxy, $("proxy").value.trim());
  setStatus("Saved.");
};

$("refresh").onclick = refreshAll;

$("saveWatch").onclick = async () => {
  try{
    const parsed = JSON.parse($("watchJson").value);
    saveJSON(KEY.watch, parsed);
    setStatus("Watchlist saved.");
    await refreshAll();
  }catch{
    alert("Watchlist JSON is not valid. Fix it and try again.");
  }
};

$("loadSample").onclick = () => {
  $("watchJson").value = JSON.stringify(SAMPLE_WATCH, null, 2);
};

/* ------------ init ------------ */
(function init(){
  $("proxy").value = load(KEY.proxy, "");
  if(!localStorage.getItem(KEY.watch)) saveJSON(KEY.watch, SAMPLE_WATCH);
  $("watchJson").value = JSON.stringify(loadJSON(KEY.watch, SAMPLE_WATCH), null, 2);
  refreshAll();
})();
</script>
</body>
</html>
