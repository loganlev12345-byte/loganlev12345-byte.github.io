<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather × Kalshi Hub (Live)</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --muted:#cbd5e1; --muted2:#94a3b8;
      --accent:#2563eb; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
    .wrap{max-width:1250px;margin:0 auto;padding:26px 14px 70px}
    h1{margin:0 0 6px;font-size:32px}
    .sub{color:var(--muted2);margin:0 0 14px;line-height:1.5}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width: 980px){ .grid{grid-template-columns: 1.05fr .95fr;} }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,button,textarea{font:inherit}
    input,textarea{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:#fff;outline:none
    }
    textarea{width:100%;min-height:170px;resize:vertical}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.12);color:#fff;cursor:pointer;font-weight:700
    }
    button.primary{background:var(--accent);border-color:rgba(255,255,255,.18)}
    button:hover{opacity:.92}
    .pill{font-size:12px;color:var(--muted2);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .tiny{font-size:12px;color:var(--muted2)}
    .divider{height:1px;background:var(--border);margin:12px 0}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted2);font-weight:800}
    td{font-size:14px}
    .badge{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;font-weight:900}
    .b-good{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.45);color:#bbf7d0}
    .b-bad{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.45);color:#fecaca}
    .b-warn{background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.45);color:#fde68a}
    a{color:#c7d2fe}
    iframe{width:100%;height:520px;border:1px solid var(--border);border-radius:14px;background:rgba(0,0,0,.08)}
    code{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Weather × Kalshi Hub (Live)</h1>
  <p class="sub">
    Pulls <b>current open markets</b> from Kalshi by <b>series ticker</b> and matches weather to the <b>exact station</b> you specify
    (ex: CLIMDW → KMDW). Uses your Cloudflare proxy for API calls.
  </p>

  <div class="card">
    <div class="row">
      <div class="pill">Proxy (Cloudflare Worker URL):</div>
      <input id="proxy" placeholder="https://your-worker.workers.dev" style="min-width:360px;flex:1">
      <div class="pill">Auto-refresh:</div>
      <input id="refreshSec" type="number" min="10" step="5" value="60" style="width:90px">
      <button id="save" class="primary">Save</button>
      <button id="refresh">Refresh now</button>
      <span id="status" class="tiny"></span>
    </div>
    <div class="tiny" style="margin-top:8px">
      If Kalshi embeds are blocked, click the market link. Prices still load via API through your proxy.
    </div>
  </div>

  <div class="grid" style="margin-top:14px">

    <!-- LEFT: CONFIG + LIVE TABLE -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Live Markets (auto)</strong>
        <span id="leftStatus" class="tiny"></span>
      </div>

      <div class="divider"></div>

      <div class="tiny muted" style="margin-bottom:8px">
        Configure series tickers + exact station IDs. Example: CLIMDW → <code>KMDW</code>, CLIMORD → <code>KORD</code>.
      </div>

      <textarea id="configJson"></textarea>

      <div class="row" style="margin-top:10px">
        <button id="saveConfig" class="primary">Save config</button>
        <button id="loadSample">Load sample</button>
      </div>

      <div class="divider"></div>

      <div id="seriesCards"></div>

      <div class="divider"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Market</th>
              <th>Series</th>
              <th>Close</th>
              <th>YES Bid</th>
              <th>YES Ask</th>
              <th>Implied P</th>
              <th>Station</th>
              <th>Obs Now</th>
              <th>Fcst High</th>
              <th>Fcst Low</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <!-- RIGHT: MARKET VIEW -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Market View</strong>
        <span id="rightStatus" class="tiny"></span>
      </div>
      <div class="divider"></div>

      <div class="tiny muted2" style="margin:6px 0 10px">
        Click any market row to load it here.
      </div>

      <div id="marketFrameWrap"></div>
    </div>
  </div>
</div>

<script>
/* ---------------- Storage ---------------- */
const KEY = {
  proxy: "hub_proxy_v3",
  refreshSec: "hub_refreshSec_v3",
  config: "hub_config_v3",
  selectedMarket: "hub_selectedMarket_v3",
};

const $ = (id) => document.getElementById(id);

function load(key, fallback){
  try{ const v = localStorage.getItem(key); return v == null ? fallback : v; }catch{ return fallback; }
}
function save(key, value){ localStorage.setItem(key, value); }
function loadJSON(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch{ return fallback; }
}
function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value, null, 2)); }

function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------------- Proxy helpers ---------------- */
function proxyWrap(url){
  const p = $("proxy").value.trim();
  if (!p) return url;
  const u = new URL(p);
  u.searchParams.set("url", url);
  return u.toString();
}

async function fetchJSON(url){
  const res = await fetch(url, { headers: { "Accept": "application/json" }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

/* ---------------- Kalshi: list markets by series ----------------
   Uses: GET /trade-api/v2/markets?series_ticker=...&status=open&min_close_ts=...
*/
async function fetchKalshiMarketsBySeries({ seriesTicker, status="open", minCloseTs=null, limit=200 }) {
  const all = [];
  let cursor = "";
  while (true) {
    const u = new URL("https://api.elections.kalshi.com/trade-api/v2/markets");
    u.searchParams.set("limit", String(limit));
    u.searchParams.set("series_ticker", seriesTicker);
    if (status) u.searchParams.set("status", status);
    if (minCloseTs) u.searchParams.set("min_close_ts", String(minCloseTs));
    if (cursor) u.searchParams.set("cursor", cursor);

    const data = await fetchJSON(proxyWrap(u.toString()));
    const markets = data?.markets || [];
    all.push(...markets);

    cursor = data?.cursor || "";
    if (!cursor) break;
  }
  return all;
}

/* ---------------- Kalshi: orderbook top-of-book ---------------- */
function extractTopOfBook(orderbookJson){
  const ob = orderbookJson?.orderbook || orderbookJson;

  let yesBids = ob?.yes?.bids || ob?.yes_bids || ob?.yesBids || [];
  let yesAsks = ob?.yes?.asks || ob?.yes_asks || ob?.yesAsks || [];

  const bestBid = yesBids?.[0];
  const bestAsk = yesAsks?.[0];

  const bid = Array.isArray(bestBid) ? bestBid[0] : bestBid?.price;
  const ask = Array.isArray(bestAsk) ? bestAsk[0] : bestAsk?.price;

  const bidNum = (bid == null ? null : Number(bid));
  const askNum = (ask == null ? null : Number(ask));

  const normalize = (x) => (x > 1 ? x/100 : x); // cents -> 0..1
  return {
    yesBid: bidNum == null ? null : normalize(bidNum),
    yesAsk: askNum == null ? null : normalize(askNum),
  };
}

function impliedProb(yesBid, yesAsk){
  if(yesBid == null && yesAsk == null) return null;
  if(yesBid != null && yesAsk != null) return (yesBid + yesAsk) / 2;
  return (yesBid != null ? yesBid : yesAsk);
}

function pct(x){
  if(x == null || Number.isNaN(x)) return "—";
  return (x*100).toFixed(1) + "%";
}

/* ---------------- NWS: exact station weather ----------------
   We do:
   1) GET /stations/{id} -> geometry coords
   2) GET /points/{lat},{lon} -> forecast url
   3) GET forecast -> pick first daytime (high) + first night (low)
   4) GET /stations/{id}/observations/latest -> current observed temp
*/
function pickHighLow(periods){
  let high=null, low=null;
  for(const p of periods){
    const name = (p.name||"").toLowerCase();
    if(!high && p.isDaytime === true && !name.includes("night")) high = p;
    if(!low && (p.isDaytime === false || name.includes("night"))) low = p;
    if(high && low) break;
  }
  return { high, low };
}
function fmtTempF(tempC){
  if(tempC == null) return "—";
  const f = (tempC * 9/5) + 32;
  return Math.round(f) + "°F";
}
function fmtForecastTemp(p){
  if(!p || p.temperature == null) return "—";
  // NWS forecast temps often already in F
  if((p.temperatureUnit||"").toUpperCase() === "F") return Math.round(Number(p.temperature)) + "°F";
  return "—";
}

async function fetchStationBundle(stationId){
  // station metadata
  const st = await fetchJSON(proxyWrap(`https://api.weather.gov/stations/${stationId}`));
  const coords = st?.geometry?.coordinates;
  if(!coords || coords.length < 2) throw new Error("Station geometry missing");
  const lon = coords[0], lat = coords[1];

  // forecast
  const points = await fetchJSON(proxyWrap(`https://api.weather.gov/points/${lat},${lon}`));
  const forecastUrl = points?.properties?.forecast;
  if(!forecastUrl) throw new Error("NWS points missing forecast url");

  const forecast = await fetchJSON(proxyWrap(forecastUrl));
  const periods = forecast?.properties?.periods;
  if(!Array.isArray(periods) || !periods.length) throw new Error("No forecast periods");
  const hl = pickHighLow(periods);

  // latest observation
  let obsNowF = "—";
  let obsTime = "";
  try{
    const obs = await fetchJSON(proxyWrap(`https://api.weather.gov/stations/${stationId}/observations/latest`));
    const c = obs?.properties?.temperature?.value; // Celsius
    obsNowF = fmtTempF(c);
    obsTime = obs?.properties?.timestamp ? new Date(obs.properties.timestamp).toLocaleString() : "";
  }catch{
    // keep as —
  }

  const name = st?.properties?.name || stationId;
  const fcHigh = fmtForecastTemp(hl.high);
  const fcLow  = fmtForecastTemp(hl.low);

  return {
    stationId,
    stationName: name,
    lat, lon,
    fcHigh, fcLow,
    obsNowF,
    obsTime
  };
}

/* ---------------- UI: market view ---------------- */
function loadMarketFrame(url){
  const wrap = $("marketFrameWrap");
  wrap.innerHTML = "";

  const frame = document.createElement("iframe");
  frame.src = url;

  const fallback = document.createElement("div");
  fallback.className = "tiny";
  fallback.style.marginTop = "8px";
  fallback.innerHTML = `If embed is blocked, <a href="${esc(url)}" target="_blank" rel="noreferrer">open market in new tab</a>.`;

  wrap.appendChild(frame);
  wrap.appendChild(fallback);
}

/* ---------------- Default config (EDIT THIS) ---------------- */
const SAMPLE_CONFIG = {
  "mode": "series",
  "status": "open",
  "daysAhead": 10,
  "series": [
    {
      "seriesTicker": "KXLOWTCHI",
      "stationId": "KMDW",
      "label": "Chicago Low Temp (CLIMDW → KMDW)"
    }
  ]
};

/* ---------------- Main refresh ---------------- */
let refreshTimer = null;

function setStatus(msg){ $("status").textContent = msg; }

async function refreshAll(){
  try{
    $("leftStatus").textContent = "Loading…";
    $("rightStatus").textContent = "";
    setStatus("Refreshing…");

    const proxy = $("proxy").value.trim();
    if(!proxy){
      setStatus("Set your proxy URL and Save.");
      $("leftStatus").textContent = "Needs proxy";
      return;
    }

    // Load config
    const cfg = loadJSON(KEY.config, SAMPLE_CONFIG);
    $("configJson").value = JSON.stringify(cfg, null, 2);

    const mode = cfg?.mode || "series";
    if(mode !== "series") throw new Error("Config mode must be 'series'");

    const status = cfg?.status || "open";
    const daysAhead = Number(cfg?.daysAhead ?? 10);
    const seriesList = Array.isArray(cfg?.series) ? cfg.series : [];

    if(seriesList.length === 0) throw new Error("No series configured");

    // Pre-fetch station bundles (exact locations)
    const stationCache = new Map();
    $("seriesCards").innerHTML = "";

    for(const s of seriesList){
      const stationId = String(s.stationId || "").toUpperCase().trim();
      const seriesTicker = String(s.seriesTicker || "").toUpperCase().trim();
      if(!stationId || !seriesTicker) continue;

      let bundle;
      try{
        bundle = await fetchStationBundle(stationId);
        stationCache.set(seriesTicker, bundle);

        const card = document.createElement("div");
        card.className = "card";
        card.style.marginBottom = "10px";
        card.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <strong>${esc(s.label || seriesTicker)}</strong>
              <div class="tiny muted2">${esc(seriesTicker)} • Station: ${esc(bundle.stationId)} (${esc(bundle.stationName)})</div>
            </div>
            <span class="pill">Obs: ${esc(bundle.obsNowF)}</span>
          </div>
          <div class="tiny muted2" style="margin-top:6px">
            Forecast High: <b>${esc(bundle.fcHigh)}</b> • Forecast Low: <b>${esc(bundle.fcLow)}</b>
            ${bundle.obsTime ? " • Obs time: " + esc(bundle.obsTime) : ""}
          </div>
        `;
        $("seriesCards").appendChild(card);
      }catch(e){
        const card = document.createElement("div");
        card.className = "card";
        card.style.marginBottom = "10px";
        card.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <strong>${esc(s.label || seriesTicker)}</strong>
              <div class="tiny muted2">${esc(seriesTicker)} • Station: ${esc(stationId)}</div>
            </div>
            <span class="badge b-bad">Station fetch failed</span>
          </div>
          <div class="tiny" style="margin-top:6px">${esc(e.message || e)}</div>
        `;
        $("seriesCards").appendChild(card);
      }
    }

    // Pull markets for each series (current markets)
    const nowTs = Math.floor(Date.now()/1000);
    const maxCloseTs = nowTs + daysAhead * 86400;

    const marketsAll = [];
    for(const s of seriesList){
      const seriesTicker = String(s.seriesTicker || "").toUpperCase().trim();
      if(!seriesTicker) continue;
      const mkts = await fetchKalshiMarketsBySeries({
        seriesTicker,
        status,
        minCloseTs: nowTs
      });

      // Filter next N days by close_time (if present)
      const filtered = mkts.filter(m => {
        const close = m.close_time ? Math.floor(new Date(m.close_time).getTime()/1000) : null;
        return close == null ? true : close <= maxCloseTs;
      });

      filtered.forEach(m => marketsAll.push({ seriesTicker, m }));
    }

    // Render rows
    const tbody = $("rows");
    tbody.innerHTML = "";
    let pricesFetched = 0;

    // Keep requests reasonable: fetch orderbooks sequentially
    for(const item of marketsAll){
      const seriesTicker = item.seriesTicker;
      const m = item.m;

      const ticker = m.ticker || "";
      const title = m.title || ticker;
      const closeTime = m.close_time ? new Date(m.close_time).toLocaleString() : "—";

      // Market page URL guess: if it fails, user can still open by searching
      // (Kalshi URLs vary; ticker is always correct)
      const marketUrl = `https://kalshi.com/markets/${String(ticker).toLowerCase()}`;

      // Orderbook URL (public)
      const orderbookUrl = `https://api.elections.kalshi.com/trade-api/v2/markets/${ticker}/orderbook`;

      // Fetch top-of-book
      let yesBid=null, yesAsk=null, imp=null;
      try{
        const ob = await fetchJSON(proxyWrap(orderbookUrl));
        const tob = extractTopOfBook(ob);
        yesBid = tob.yesBid; yesAsk = tob.yesAsk;
        imp = impliedProb(yesBid, yesAsk);
        pricesFetched++;
      }catch{
        // ignore
      }

      const st = stationCache.get(seriesTicker);
      const stationId = st?.stationId || "—";
      const obsNowF = st?.obsNowF || "—";
      const fcHigh = st?.fcHigh || "—";
      const fcLow  = st?.fcLow  || "—";

      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.innerHTML = `
        <td>
          <div><strong>${esc(title)}</strong></div>
          <div class="tiny"><a href="${esc(marketUrl)}" target="_blank" rel="noreferrer">Open</a> • <span class="tiny muted2">${esc(ticker)}</span></div>
        </td>
        <td>${esc(seriesTicker)}</td>
        <td>${esc(closeTime)}</td>
        <td>${yesBid == null ? "—" : pct(yesBid)}</td>
        <td>${yesAsk == null ? "—" : pct(yesAsk)}</td>
        <td>${imp == null ? "—" : pct(imp)}</td>
        <td>${esc(stationId)}</td>
        <td>${esc(obsNowF)}</td>
        <td>${esc(fcHigh)}</td>
        <td>${esc(fcLow)}</td>
      `;

      tr.addEventListener("click", () => {
        save(KEY.selectedMarket, marketUrl);
        loadMarketFrame(marketUrl);
        $("rightStatus").textContent = ticker ? `Loaded ${ticker}` : "Loaded";
      });

      tbody.appendChild(tr);
    }

    // Load selected market frame
    const sel = load(KEY.selectedMarket, marketsAll[0]?.m?.ticker ? `https://kalshi.com/markets/${String(marketsAll[0].m.ticker).toLowerCase()}` : "https://kalshi.com/");
    loadMarketFrame(sel);

    $("leftStatus").textContent = `Series: ${seriesList.length} • Markets: ${marketsAll.length} • Prices: ${pricesFetched}`;
    setStatus("Done.");
  }catch(e){
    setStatus("Error: " + (e.message || e));
    $("leftStatus").textContent = "Error";
  }
}

/* ---------------- UI wiring ---------------- */
$("save").onclick = () => {
  save(KEY.proxy, $("proxy").value.trim());
  save(KEY.refreshSec, $("refreshSec").value.trim());
  setStatus("Saved.");
  startAutoRefresh();
};

$("refresh").onclick = refreshAll;

$("saveConfig").onclick = async () => {
  try{
    const parsed = JSON.parse($("configJson").value);
    saveJSON(KEY.config, parsed);
    setStatus("Config saved.");
    await refreshAll();
  }catch{
    alert("Config JSON is not valid. Fix it and try again.");
  }
};

$("loadSample").onclick = () => {
  $("configJson").value = JSON.stringify(SAMPLE_CONFIG, null, 2);
};

function startAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  const sec = Math.max(10, Number($("refreshSec").value || 60));
  refreshTimer = setInterval(refreshAll, sec * 1000);
}

/* ---------------- init ---------------- */
(function init(){
  $("proxy").value = load(KEY.proxy, "");
  $("refreshSec").value = load(KEY.refreshSec, "60");
  if(!localStorage.getItem(KEY.config)) saveJSON(KEY.config, SAMPLE_CONFIG);
  $("configJson").value = JSON.stringify(loadJSON(KEY.config, SAMPLE_CONFIG), null, 2);
  refreshAll();
  startAutoRefresh();
})();
</script>
</body>
</html>
